"use strict";angular.module("childSponsorshipWebApp",["ngAnimate","ngCookies","ngResource","ngSanitize","ngTouch","ui.router","ui.gravatar","ngFileUpload","angularFileUpload"]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){c.defaults.useXDomain=!0,delete c.defaults.headers.common["X-Requested-With"],a.state("home",{url:"/",templateUrl:"views/splash.html",controller:"SplashController"}).state("login",{url:"/login",templateUrl:"views/login.html",controller:"LoginController"}).state("signup",{url:"/signup",templateUrl:"views/signup.html",controller:"SignupController"}).state("children",{url:"/children",templateUrl:"views/child/index.html",controller:"ChildrenListController",resolve:{childrenResource:"Child",children:["childrenResource",function(a){return a.query()}]}}).state("viewChild",{url:"/children/:id/view",templateUrl:"views/child/view.html",controller:"ChildrenViewController"}).state("newChild",{url:"/children/new",templateUrl:"views/child/new.html",controller:"ChildrenCreateController"}).state("editChild",{url:"/children/:id/edit",templateUrl:"views/child/edit.html",controller:"ChildrenEditController"}).state("sponsorChild",{url:"/sponsor",templateUrl:"views/child/available.html",controller:"ChildrenAvailableContoller"}).state("sponsorChildPayment",{url:"/children/:id/sponsor",templateUrl:"views/child/sponsor.html",controller:"ChildrenSponsorContoller"}).state("addChildImages",{url:"/children/:id/photos",templateUrl:"views/child/addPhotos.html",controller:"ChildrenPhotosController"}).state("users",{url:"/users",templateUrl:"views/user/index.html",controller:"UsersListController",resolve:{usersResource:"User",users:["usersResource",function(a){return a.query()}]}}).state("viewUser",{url:"/users/:id/view",templateUrl:"views/user/view.html",controller:"UsersViewController"}).state("newUser",{url:"/users/new",templateUrl:"views/user/new.html",controller:"UsersCreateController"}).state("editUser",{url:"/users/:id/edit",templateUrl:"views/user/edit.html",controller:"UsersEditController"}).state("userChildren",{url:"/users/:id/children/view",templateUrl:"views/user/children.html",controller:"UsersChildrenController"})}]).run(["$state",function(a){a.go("home")}]),angular.module("childSponsorshipWebApp").directive("input-equals",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){if(d){a.$watch(c.ngModel,function(){e()}),c.$observe("equals",function(a){e()});var e=function(){var a=d.$viewValue,b=c.equals;d.$setValidity("equals",!a||!b||a===b)}}}}}),angular.module("childSponsorshipWebApp").directive("ngThumb",["$window",function(a){var b={support:!(!a.FileReader||!a.CanvasRenderingContext2D),isFile:function(b){return angular.isObject(b)&&b instanceof a.File},isImage:function(a){var b="|"+a.type.slice(a.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(b)}};return{restrict:"A",template:"<canvas/>",link:function(a,c,d){function e(a){var b=new Image;b.onload=f,b.src=a.target.result}function f(){var a=g.width||this.width/this.height*g.height,b=g.height||this.height/this.width*g.width;h.attr({width:a,height:b}),h[0].getContext("2d").drawImage(this,0,0,a,b)}if(b.support){var g=a.$eval(d.ngThumb);if(b.isFile(g.file)&&b.isImage(g.file)){var h=c.find("canvas"),i=new FileReader;i.onload=e,i.readAsDataURL(g.file)}}}}}]),angular.module("childSponsorshipWebApp").factory("authService",["$rootScope","$location","$q","apiService",function(a,b,c,d){var e,f=function(b,c,f){d.post(b,{email:c,password:f}).success(function(b,c,f,g){localStorage.setItem("api-token",b.token),d.get("/user").success(function(b,c,d,f){e=b,localStorage.setItem("email",e.email),localStorage.setItem("access",e.access),a.$broadcast("login.success")})}).error(function(b,c,d){alert("error: "+c),a.$broadcast("login.failed",d)})},g=function(){return void 0===accessRequired||null==accessRequired||0==accessRequired?!0:void 0!==localStorage.getItem("access")&&localStorage.getItem("access")>=accessRequired},h=function(){d.get("/logout"),localStorage.removeItem("email"),localStorage.removeItem("name"),localStorage.removeItem("access"),localStorage.removeItem("api-token"),a.$broadcast("logout.success")},i=function(a,b){f("/login",a,b)},j=function(b,c){f("/signup",b,c).then(function(){a.$broadcast("login.success")},function(b){a.$broadcast("login.failed",b)})},k=function(){return localStorage.getItem("email")},l=function(){return!!k()},m=function(){return localStorage.getItem("access")>5?!0:!1},n=function(){return l()?!0:c.reject("Not Authorized")},o=function(){return void 0==e&&d.get("/user").success(function(b,c,d,f){e=b,a.$broadcast("user.success")}),e};return{routeIsAccessible:g,login:i,signup:j,email:k,isLoggedIn:l,isAdmin:m,logout:h,isAuthorized:n,currentUser:o}}]),angular.module("childSponsorshipWebApp").factory("apiService",["$http",function(a){var b="child-sponsorship-web.herokuapp.com"===window.location.host?config.production.api.url:config.development.api.url,c={token:function(){return localStorage.getItem("api-token")}};return c.get=function(d,e){return a.get(b+d+"?token="+c.token(),e)},c["delete"]=function(d,e){return a["delete"](b+d+"?token="+c.token(),e)},c.post=function(d,e,f){var g={};for(var h in e)g[h]=e[h];return g.token=c.token(),a.post(b+d,g,f)},c}]),angular.module("childSponsorshipWebApp").factory("User",["$resource",function(a){var b="child-sponsorship-web.herokuapp.com"===window.location.host?config.production.api.url:config.development.api.url;return a(b+"/users/:id",{id:"@id",token:localStorage.getItem("api-token")},{update:{method:"POST"}})}]),angular.module("childSponsorshipWebApp").factory("Child",["$resource",function(a){var b="child-sponsorship-web.herokuapp.com"===window.location.host?config.production.api.url:config.development.api.url;return a(b+"/children/:id",{id:"@id",token:localStorage.getItem("api-token")},{update:{method:"PUT"}})}]),angular.module("childSponsorshipWebApp").service("popupService",["$window",function(a){this.showPopup=function(b){return a.confirm(b)}}]),angular.module("childSponsorshipWebApp").controller("AdminCtrl",["$scope","authService","apiService",function(a,b,c){a.email=b.email(),c.get("/data-only-admins-can-see").success(function(b,c){a.data=b.data})}]),angular.module("childSponsorshipWebApp").controller("LogoutCtrl",["$scope","$location","authService",function(a,b,c){c.logout(),b.path("/").replace()}]),angular.module("childSponsorshipWebApp").controller("HomeCtrl",["$scope","authService","apiService",function(a,b,c){a.email=b.email(),c.get("/data-only-users-can-see").success(function(b,c){a.data=b.data})}]),angular.module("childSponsorshipWebApp").controller("LoginController",["$scope","$state","$rootElement","authService",function(a,b,c,d){a.authenticate=function(){d.login(a.email,a.password)},window.setTimeout(function(){c.find("input").checkAndTriggerAutoFillEvent()},200),a.$root.$on("login.success",function(){b.go("home")}),a.toastPosition={bottom:!0,top:!1,left:!1,right:!1},a.getToastPosition=function(){return Object.keys(a.toastPosition).filter(function(b){return a.toastPosition[b]}).join(" ")},a.showSimpleToast=function(){$mdToast.show($mdToast.simple().content("").position(a.getToastPosition()).hideDelay(0))}}]),angular.module("childSponsorshipWebApp").controller("SignupController",["$scope","$rootElement","authService",function(a,b,c){a.submit=function(b,d,e){if(a.submitted=!0,d==e)c.signup(a.email,a.password);else{var f="";a.form.email.$invalid&&(f+="Invalid email address"),d!=e&&(f+=""==f?f:", ",f+="Passwords do not match"),a.error={message:f}}},a.$root.$on("signup.success",function(b,c){a.$apply(function(){$location.path("/login")})}),a.$root.$on("signup.failed",function(b,c){a.$apply(function(){a.error=c})}),window.setTimeout(function(){b.find("input").checkAndTriggerAutoFillEvent()},200)}]),angular.module("childSponsorshipWebApp").controller("SplashController",["$scope","apiService","authService",function(a,b,c){a.$on("login.success",function(){a.isLoggedIn=c.isLoggedIn(),a.user=c.currentUser()}),a.$on("user.success",function(){a.isLoggedIn=c.isLoggedIn(),a.user=c.currentUser()})}]),angular.module("childSponsorshipWebApp").controller("UsersListController",["$scope","$state","popupService","$window","User",function(a,b,c,d,e){a.users=e.query(),a.deleteUser=function(a){c.showPopup("Really delete this?")&&a.$delete(function(){$rootScope.$broadcast("user.deleted"),b.go("users")})}}]).controller("UsersViewController",["$scope","$stateParams","User",function(a,b,c){a.user=c.get({id:b.id}),a.user.$promise.then(function(b){b.children;a.children=JSON.parse(b.children)})}]).controller("UsersCreateController",["$scope","$rootScope","$state","$stateParams","User",function(a,b,c,d,e){a.user=new e,a.addUser=function(){a.user.$save(function(){b.$broadcast("user.created"),c.go("users")})}}]).controller("UsersEditController",["$scope","$rootScope","$state","$stateParams","User",function(a,b,c,d,e){a.updateUser=function(){a.user.$save(function(){b.$broadcast("user.updated"),c.go("users")})},a.loadUser=function(){a.user=e.get({id:d.id})},a.loadUser()}]).controller("UsersChildrenController",["$scope","$state","$stateParams","User",function(a,b,c,d){a.user=d.get({id:c.id}),a.user.$promise.then(function(b){b.children;a.children=JSON.parse(b.children)})}]),angular.module("childSponsorshipWebApp").controller("ChildrenListController",["$scope","$state","popupService","$window","Child",function(a,b,c,d,e){a.children=e.query(),console.info("children: ",a.children.$promise),a.deleteChild=function(a){c.showPopup("Really delete this?")&&a.$delete(function(){d.location.href=""})}}]).controller("ChildrenViewController",["$scope","$stateParams","Child",function(a,b,c){a.child=c.get({id:b.id})}]).controller("ChildrenCreateController",["$scope","$state","popupService","$stateParams","Child","apiService",function(a,b,c,d,e,f){$("#description").characterCounter(),a.child=new e,a.datepicker=function(){$(".datepicker").pickadate({selectMonths:!0,selectYears:25})},a.addChild=function(){a.child.$save(function(){b.go("children")})}}]).controller("ChildrenEditController",["$scope","$state","$stateParams","Child",function(a,b,c,d){$("#description").characterCounter(),a.updateChild=function(){a.child.$update(function(){b.go("children")})},a.datepicker=function(){$(".datepicker").pickadate({selectMonths:!0,selectYears:25})},a.loadChild=function(){a.child=d.get({id:c.id})},a.loadChild()}]).controller("ChildrenPhotosController",["$scope","$http","$state","$stateParams","Child","FileUploader","apiService",function(a,b,c,d,e,f,g){a.uploader=new f(g.get("/signed_url").success(function(b,c,d,e){a.signed_form=b,a.uploader.url=a.signed_form.url,a.uploader.withCredentials=!0,a.uploader.autoUpload=!0})),a.child=e.get({id:d.id});var h=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+a()+a()+a()+a()+a()+a()};h();a.upload=function(c){b({method:"POST",url:a.signed_form.url,headers:{"Content-Type":"multipart/form-data"},data:c._file})},a.setFormData=function(b){b.formData[0]={key:"uploads//"+a.child.name+"-"+a.child.id+"/"+h()+b._file.name,AWSAccessKeyId:a.signed_form.access_id,acl:a.signed_form.acl,policy:a.signed_form.policy,signature:a.signed_form.signature,"Content-Type":null===b._file.type||""===b._file.type?"application/octet-stream":b._file.type,filename:b._file.name,success_action_status:"201"}},a.uploader.onAfterAddingFile=function(a){console.info("onAfterAdding",a)},a.uploader.onBeforeUploadItem=function(b){a.setFormData(b),console.info("onBeforeUploadItem",b)},a.uploader.onAfterAddingAll=function(b){console.info("onAfterAddingAll",b);for(var c in b)a.setFormData(b[c]),console.info("onAfterAddingAll.fileItem",c)},a.uploader.onSuccessItem=function(b,c,d,e){console.info("onSuccessItem",c);var f=$.parseXML(c),h=$(f),i=h.find("Location").text();g.post("/children/"+a.child.id+"/photos/new",{url:i,caption:"test"}).success(function(a,b,c,d){}).error(function(a){alert("Failure! :(")})},a.uploader.onErrorItem=function(a,b,c,d){console.info("onErrorItem",a,b,c,d),alert("There was an error uploading the image."+a)},a.uploader.onCompleteItem=function(a,b,c,d){}}]).controller("ChildrenAvailableContoller",["$scope","$state","$stateParams","Child","apiService","authService",function(a,b,c,d,e,f){e.get("/children/available").success(function(b,c,d,e){a.available=b}).error(function(a,b){alert("error: "+b),$rootScope.$broadcast("children.available.failed",error)}),a.sponsor=function(a){var b=f.currentUser(),c=StripeCheckout.configure({key:"pk_test_H6bg1MhKkinX8GVyFFiILbcJ",image:a.child_photos[0].url,email:b.email,token:function(c){e.post("/charge",{stripeToken:c,child_id:a.id,user_id:b.id}).success(function(a,b,c,d){}).error(function(a,b){alert("error: "+b+" : "+a)})}});c.open({name:"Child Sponsorship",description:a.name+" — "+a.description,"panel-label":"Sponsor — $35"}),$(window).on("popstate",function(){c.close()})}}]);var config=config||{};config.development={app:"child-sponsorship-web-development",api:{url:"http://localhost:5000/api/v1"}},config.production={app:"child-sponsorship-web",api:{url:"https://child-sponsorship-api.herokuapp.com/api/v1"}},function(a){function b(){var a,b;for(a=0;a<this.length;a++)b=this[a],c(b)||(d(b),i(b))}function c(a){"$$currentValue"in a||(a.$$currentValue=a.getAttribute("value"));var b=a.value,c=a.$$currentValue;return b||c?b===c:!0}function d(a){a.$$currentValue=a.value}function e(b){var c=a.jQuery||a.angular.element,d=c.prototype,e=d.val;d.val=function(a){var c=e.apply(this,arguments);return arguments.length>0&&h(this,function(c){b(c,a)}),c}}function f(a,b){function c(a){var c=a.target;b(c)}k.addEventListener(a,c,!0)}function g(a){for(;a;){if("FORM"===a.nodeName)return j(a);a=a.parentNode}return j()}function h(a,b){if(a.forEach)return a.forEach(b);var c;for(c=0;c<a.length;c++)b(a[c])}function i(b){var c=a.document,d=c.createEvent("HTMLEvents");d.initEvent("change",!0,!0),b.dispatchEvent(d)}var j=a.jQuery||a.angular.element,k=a.document.documentElement,l=j(k);f("change",d),e(d),j.prototype.checkAndTriggerAutoFillEvent=b,f("blur",function(b){a.setTimeout(function(){g(b).find("input").checkAndTriggerAutoFillEvent()},20)}),a.document.addEventListener("DOMContentLoaded",function(){h(document.getElementsByTagName("input"),d),a.setTimeout(function(){l.find("input").checkAndTriggerAutoFillEvent()},200)},!1)}(window),angular.module("childSponsorshipWebApp").directive("navbar",function(){return{templateUrl:"/views/templates/navbar.html",restrict:"E",link:function(a,b,c){},controller:["$scope","$state","authService",function(a,b,c){a.$on("$viewContentLoaded",function(){$(".button-collapse").sideNav(),$(".dropdown-button").dropdown(),a.isLoggedIn=c.isLoggedIn(),a.isAdmin=c.isAdmin(),a.user=c.currentUser()}),a.$on("user.success",function(){a.isLoggedIn=c.isLoggedIn(),a.isAdmin=c.isAdmin(),a.user=c.currentUser()}),a.$on("login.success",function(){a.isLoggedIn=c.isLoggedIn(),a.isAdmin=c.isAdmin(),a.user=c.currentUser()}),a.$on("logout.success",function(){a.isLoggedIn=c.isLoggedIn(),a.isAdmin=c.isAdmin(),a.user=c.currentUser(),b.go("home")}),a.logout=function(){c.logout()},a.children=function(){b.go("children")},a.sponsor=function(){b.go("sponsorChild")},a.home=function(){b.go("home")},a.users=function(){b.go("users")},a.userChildren=function(){b.go("userChildren")}}]}});